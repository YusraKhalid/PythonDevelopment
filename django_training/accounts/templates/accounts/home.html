{% extends 'accounts/base.html' %}

{% block title %} Homepage {% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        <p>Hi {{ user.username }} | <a href="{% url 'logout' %}">Logout</a></p>
        <h3>
            <a href="{% url 'create_blog' %}">Add New Blog</a>
        </h3>

    {% else %}
        <p>
           <a href="{% url 'login' %}">Login/</a>
           <a href="{% url 'signup' %}">Signup</a>
        </p>
    {% endif %}


    <h1>Blogs List</h1>
    <div class="panel-group" id="accordion"></div>

{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        $(document).ready(function(){
            $.ajax({
                    method: "GET",
                    url: "/apis/blogs/?format=json",
                    success: function( blogs ) {
                        blogs.forEach(function(element){
                            edit = ""
                            if (element["is_owner"] == true)
                                edit = `
                                    <small>(
                                    <a href="/blogs/update_blog/${element["id"]}"} class="btn btn-link" role="button">Edit</a>|
                                    <a class="btn btn-link js-tooltip" href="#" title="Make a DELETE request on the Blog Detail resource" data-toggle="modal" data-target="#deleteModal">DELETE</a>

                                     <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                      <div class="modal-dialog">
                                        <div class="modal-content">
                                          <div class="modal-body">
                                            <h4 class="text-center">Are you sure you want to delete this Blog Detail?</h4>
                                          </div>
                                          <div class="modal-footer">
                                             <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                             <form class="button-form" action="/apis/blog/${element["id"]}/" id="${element["id"]}" data-method="DELETE">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger delete_blog">Delete</button>
                                             </form>
                                             <!--<a id="${element["id"]}" role="button" class="btn btn-danger delete_blog">Delete</a>-->
                                          </div>
                                        </div>
                                      </div>
                                     </div>
                                    )</small>`


                            li2 = `
                                <div class="panel panel-default" id="panel_${element["id"]}">
                                    <div class="panel-heading">
                                      <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#blog_${element["id"]}"> ${element["blog_title"]}</a>
                                        ${edit}
                                      </h4>
                                    </div>
                                    <div id="blog_${element["id"]}" class="panel-collapse collapse in">
                                      <div class="panel-body">${element["blog_description"]}</div>
                                    </div>
                                </div>
                            `

                            $(".panel-group").append(li2)
                        });

                        $('.button-form').submit(function(){
                            var blg_id = $(this).attr("id");
                            var token = '{{csrf_token}}';
                            $.ajax({
                                headers: { "X-CSRFToken": '{{csrf_token}}'},
                                method: "DELETE",
                                url: "/apis/blog/" + blg_id + "/",
                                data: $(this).serialize(),
                                success: function( result ) {
                                    alert('Your blog is successfully deleted' + result);
                                    blog_id = '#panel_' + blg_id;
                                    $(blog_id).remove();
                                }
                            });
                            return false;
                        });

                    }
            });

        });
    </script>
{% endblock %}
